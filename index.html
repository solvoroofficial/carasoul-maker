<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes" />
  <title>Carasoul Solvoro ¬∑ friendly carousel maker</title>

  <!-- Manifest & theme -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#6c5ce7">

  <!-- iOS: show custom icon when Add to Home Screen -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Carasoul Solvoro">

  <!-- font + Fabric -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    /* --- keep your existing styles, plus small touch & friendly improvements --- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Quicksand',sans-serif;background:linear-gradient(145deg,#0f0f17 0%,#1a1a28 100%);color:#f0eef7;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .glass-app{width:1500px;max-width:100%;background:rgba(22,22,30,0.9);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:32px;box-shadow:0 30px 60px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.04) inset;overflow:hidden}
    .app-grid{display:flex;flex-direction:row}
    .settings-panel{width:380px;background:rgba(18,18,26,0.75);backdrop-filter:blur(8px);padding:20px;border-right:1px solid rgba(255,255,255,.03);overflow-y:auto;display:flex;flex-direction:column;gap:18px}
    .welcome-header{display:flex;align-items:center;flex-wrap:wrap;gap:8px 12px}
    .logo{height:44px;width:auto;display:block;object-fit:contain}
    .beta-badge{background:#7d6cf0;padding:6px 14px;border-radius:60px;font-size:16px;font-weight:500;color:white;white-space:nowrap}
    .welcome-header p{font-size:15px;color:#b5b2d0;width:100%;margin-top:4px;line-height:1.45}
    .card{background:rgba(12,12,20,0.55);border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,.03);box-shadow:0 12px 18px -12px black}
    .card-title{font-size:13px;font-weight:700;color:#cbc8ff;margin-bottom:12px;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.4px}
    .upload-drop{background:rgba(38,35,58,0.55);border-radius:16px;padding:14px 12px;border:2px dashed #5a4d9c;text-align:center;transition:.14s;cursor:pointer}
    .upload-drop:hover{background:#322f4a;border-color:#9b8cff}
    .upload-label{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
    .upload-label .icon{font-size:28px;filter:drop-shadow(0 6px 8px #00000050)}
    .bg-preview{display:flex;align-items:center;justify-content:space-between;background:#1d1b2b;border-radius:20px;padding:8px 12px;margin-top:12px;font-size:13px}
    .chip-button{background:none;border:none;color:#f0d6ff;font-size:18px;cursor:pointer;padding:0 6px}
    .size-options{display:flex;gap:10px;margin:6px 0}
    .size-btn{flex:1;background:#222032;border:1px solid #3e3b58;border-radius:40px;padding:8px 0;font-weight:700;color:#cbc8f0;cursor:pointer;transition:.12s;font-size:13px}
    .size-btn.active{background:#5f51c0;border-color:#9b8aff;color:white;box-shadow:0 8px 14px #2d218050}
    .text-field{background:#201f2c;border-radius:60px;padding:6px 8px;display:flex;align-items:center;border:1px solid #4f4a70}
    .text-field input{background:transparent;border:none;padding:12px 0;font-size:15px;width:100%;color:white;outline:none;font-family:'Quicksand',sans-serif}
    .slider-item{display:flex;flex-direction:column;gap:6px}
    .slider-header{display:flex;justify-content:space-between;font-size:13px;color:#cac5f0}
    input[type=range]{width:100%;height:6px;background:#2d2a40;border-radius:20px;-webkit-appearance:none}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:#fff;border-radius:50%;border:2px solid #8a7cff;box-shadow:0 4px 9px rgba(0,0,0,.6);cursor:pointer}
    .color-row{display:flex;align-items:center;gap:12px;background:#201f2c;border-radius:40px;padding:8px 12px}
    #textColor{width:46px;height:36px;border-radius:28px;border:2px solid #5550a0;background:transparent}
    .shadow-check{display:flex;align-items:center;gap:12px;background:#201f2c;border-radius:40px;padding:10px 14px}
    .action-row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .btn{background:#2d2a44;border:none;padding:12px 14px;border-radius:50px;font-weight:700;font-size:14px;color:#f0eaff;cursor:pointer;transition:.12s;display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #524d78}
    .btn-primary{background:#6c5ce7;border-color:#9b8cff;color:white;box-shadow:0 10px 18px #3a2e9e40}
    .preview-area{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(circle at 30% 40%, #262337, #0c0b14)}
    .canvas-frame{background:#161222;border-radius:20px;padding:12px;box-shadow:0 30px 60px -10px black,0 0 0 1px #514b80 inset;max-width:100%;transition:all .16s ease}
    #carouselCanvas{display:block;width:100%;height:auto;border-radius:12px;background:#18152a}
    .helper-note{color:#8d87b5;font-size:13px;margin-top:12px;text-align:center}

    /* friendly small install button */
    .install-row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
    .install-btn{background:#3bd671;color:#02100a;padding:10px 12px;border-radius:12px;font-weight:800;border:none;cursor:pointer;box-shadow:0 6px 14px rgba(59,214,113,.12)}
    .hint{font-size:12px;color:#bbb3df}

    @media (max-width:950px){.app-grid{flex-direction:column}.settings-panel{width:100%;border-right:none;border-bottom:1px solid #34304a}}
    @media (max-width:600px){.logo{height:34px}.beta-badge{padding:4px 10px;font-size:14px}}
  </style>
</head>
<body>
  <div class="glass-app">
    <div class="app-grid">

      <!-- LEFT: controls -->
      <div class="settings-panel">
        <div class="welcome-header">
          <img src="logo.png" alt="Carasoul Solvoro" class="logo" onerror="this.style.display='none'">
          <span class="beta-badge">beta</span>
          <p>make Instagram slides in seconds ‚Äî background stays saved in your browser. Tap Install to add to home screen.</p>
        </div>

        <!-- Quick install UI -->
        <div class="card">
          <div class="card-title">üì± Install</div>
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:700">Install Carasoul</div>
              <div class="hint">Add this to your phone for one-tap access.</div>
            </div>
            <div>
              <button id="installBtn" class="install-btn" style="display:none">Install</button>
              <div id="iosInstall" style="display:none;text-align:right;font-size:12px;color:#bdb4e8">iOS: Share ‚Üí Add to Home Screen</div>
            </div>
          </div>
        </div>

        <!-- Background -->
        <div class="card">
          <div class="card-title">üì∏ 1. your background</div>
          <div class="upload-drop" id="uploadDrop">
            <label for="bgUpload" class="upload-label">
              <span class="icon">üñºÔ∏è</span>
              <span style="font-weight:700">click to upload image</span>
              <span style="font-size:12px;color:#aaa2d5">PNG or JPG (auto saved)</span>
            </label>
            <input type="file" id="bgUpload" accept="image/png, image/jpeg, image/jpg, image/webp" hidden>
          </div>
          <div class="bg-preview" id="bgStatus">
            <span>üíæ <span id="bgMessage">no background yet</span></span>
            <button class="chip-button" id="clearBgBtn" title="remove">üóëÔ∏è</button>
          </div>
        </div>

        <!-- canvas shape -->
        <div class="card">
          <div class="card-title">üî≤ 2. canvas shape</div>
          <div class="size-options">
            <button id="sizeSquareBtn" class="size-btn active">‚¨õ square 1:1</button>
            <button id="sizeMatchBtn" class="size-btn">üñºÔ∏è match image</button>
          </div>
          <div style="font-size:12px;color:#afa7dd;margin-top:6px">"match image" adjusts canvas to your photo's proportions (max side 1080px)</div>
        </div>

        <!-- text -->
        <div class="card">
          <div class="card-title">‚úçÔ∏è 3. your message</div>
          <div class="text-field">
            <input type="text" id="textInput" placeholder="e.g. 'summer vibes'" value="Carasoul Solvoro">
          </div>

          <div style="margin:12px 0 6px">
            <div class="slider-item">
              <div class="slider-header"><span>üî§ size</span><span id="fontSizeVal">58</span></div>
              <input type="range" id="fontSizeSlider" min="16" max="140" value="58" step="1">
            </div>
            <div class="slider-item">
              <div class="slider-header"><span>üìè line height</span><span id="lineHeightVal">1.3</span></div>
              <input type="range" id="lineHeightSlider" min="1.0" max="2.5" value="1.3" step="0.1">
            </div>
            <div class="slider-item">
              <div class="slider-header"><span>üßò padding</span><span id="paddingVal">32</span></div>
              <input type="range" id="paddingSlider" min="0" max="120" value="32" step="2">
            </div>
          </div>

          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
            <select id="fontWeightSelect" style="background:#201f2c;border-radius:60px;padding:10px 14px;border:1px solid #4f4a70;color:white;flex:1">
              <option value="normal">Regular weight</option>
              <option value="bold" selected>Bold weight</option>
            </select>
            <div class="color-row" style="flex:1">
              <span>üé®</span>
              <input type="color" id="textColor" value="#ffffff">
            </div>
          </div>

          <div class="shadow-check" style="margin-top:10px">
            <input type="checkbox" id="shadowToggle" checked>
            <label for="shadowToggle">üåí soft shadow (makes text pop)</label>
          </div>
        </div>

        <!-- actions -->
        <div class="card">
          <div class="card-title">üì• 4. export & play</div>
          <div class="action-row">
            <button class="btn btn-primary" id="downloadPngBtn">üì∏ PNG</button>
            <button class="btn btn-primary" id="downloadJpgBtn">üåÖ JPG</button>
          </div>
          <div class="action-row">
            <button class="btn" id="duplicateSlideBtn">‚ûï duplicate text</button>
            <button class="btn" id="resetTextBtn">‚Ü∫ reset style</button>
          </div>
          <div class="helper-note">‚¨áÔ∏è downloads at exact canvas size (ready for Instagram)</div>
        </div>
      </div>

      <!-- RIGHT: preview -->
      <div class="preview-area">
        <div class="canvas-frame" id="canvasFrame">
          <canvas id="carouselCanvas" width="1080" height="1080"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ---- Fabric app script (kept your logic, small extra: resize canvas on orientation change) ---- -->
  <script>
  (function(){
    const canvasEl = document.getElementById('carouselCanvas');
    let canvas = new fabric.Canvas(canvasEl,{
      enableRetinaScaling: true,
      backgroundColor:'#18152a',
      preserveObjectStacking:false,
      width:1080,
      height:1080
    });

    let textbox = null;
    const STORAGE_KEY = 'carasoul_solvoro_bg';
    let currentImageWidth = 1080, currentImageHeight = 1080;
    let matchMode = false;

    function resizeCanvas(newWidth,newHeight){
      if(newWidth<10||newHeight<10) return;
      const oldBg = canvas.backgroundImage;
      const oldText = textbox;
      canvas.setWidth(newWidth).setHeight(newHeight);
      if(oldBg){
        const img = oldBg;
        const scale = Math.max(newWidth / img.width, newHeight / img.height);
        img.set({scaleX:scale,scaleY:scale,left:(newWidth - img.width * scale)/2,top:(newHeight - img.height * scale)/2});
        canvas.setBackgroundImage(img,canvas.renderAll.bind(canvas));
      }
      if(oldText){
        oldText.set({left:newWidth/2,top:newHeight/2,width:newWidth * 0.8});
        canvas.renderAll();
      } else initTextbox();
      canvas.renderAll();
    }

    function saveBackgroundToStorage(dataURL){
      try{
        localStorage.setItem(STORAGE_KEY,dataURL);
        document.getElementById('bgMessage').innerText = 'saved in browser';
      }catch(e){
        alert('Image too large for storage, try a smaller image.');
      }
    }

    function loadBackgroundFromStorage(){
      const savedDataURL = localStorage.getItem(STORAGE_KEY);
      if(savedDataURL){
        fabric.Image.fromURL(savedDataURL,(img)=>{
          currentImageWidth = img.width;
          currentImageHeight = img.height;
          if(matchMode){
            let targetW=img.width,targetH=img.height;const maxDim=1080;
            if(targetW>maxDim||targetH>maxDim){
              const ratio = Math.min(maxDim/targetW, maxDim/targetH);
              targetW = Math.floor(targetW*ratio); targetH = Math.floor(targetH*ratio);
            }
            resizeCanvas(targetW,targetH);
          }
          const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
          img.set({scaleX:scale,scaleY:scale,left:(canvas.width - img.width * scale)/2,top:(canvas.height - img.height * scale)/2});
          canvas.setBackgroundImage(img,canvas.renderAll.bind(canvas));
          document.getElementById('bgMessage').innerText = 'background ready';
        },{crossOrigin:'anonymous'});
      } else {
        document.getElementById('bgMessage').innerText = 'no background saved';
      }
    }

    // upload handler
    document.getElementById('bgUpload').addEventListener('change', function(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (event)=>{
        const dataURL = event.target.result;
        fabric.Image.fromURL(dataURL,(img)=>{
          currentImageWidth = img.width; currentImageHeight = img.height;
          if(matchMode){
            let targetW=img.width,targetH=img.height;const maxDim=1080;
            if(targetW>maxDim||targetH>maxDim){
              const ratio = Math.min(maxDim/targetW, maxDim/targetH);
              targetW = Math.floor(targetW*ratio); targetH = Math.floor(targetH*ratio);
            }
            resizeCanvas(targetW,targetH);
          } else {
            if(canvas.width !== 1080 || canvas.height !== 1080) resizeCanvas(1080,1080);
          }
          const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
          img.set({scaleX:scale,scaleY:scale,left:(canvas.width - img.width * scale)/2,top:(canvas.height - img.height * scale)/2});
          canvas.setBackgroundImage(img,canvas.renderAll.bind(canvas));
          saveBackgroundToStorage(dataURL);
        },{crossOrigin:'anonymous'});
      };
      reader.readAsDataURL(file);
      this.value = '';
    });

    document.getElementById('clearBgBtn').addEventListener('click', function(){
      canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('bgMessage').innerText = 'no background';
    });

    function initTextbox(){
      if(textbox) canvas.remove(textbox);
      const text = document.getElementById('textInput').value || 'Carasoul Solvoro';
      const fontSize = parseInt(document.getElementById('fontSizeSlider').value,10);
      const fontWeight = document.getElementById('fontWeightSelect').value;
      const color = document.getElementById('textColor').value;
      const lineHeight = parseFloat(document.getElementById('lineHeightSlider').value);
      const padding = parseInt(document.getElementById('paddingSlider').value,10);
      const shadowEnabled = document.getElementById('shadowToggle').checked;

      textbox = new fabric.Textbox(text,{
        left: canvas.width/2, top: canvas.height/2, originX:'center', originY:'center',
        fontSize,fontWeight,fill:color,lineHeight,padding,textAlign:'center',
        fontFamily:'Quicksand, sans-serif', width: canvas.width * 0.8,
        shadow: shadowEnabled ? 'rgba(0,0,0,0.5) 0px 8px 18px' : '',
        splitByGrapheme:true, hasControls:false, hasBorders:false, lockScalingX:true, lockScalingY:true, selectable:false, evented:false
      });
      canvas.add(textbox); canvas.renderAll();
    }

    function updateTextProperties(){
      if(!textbox){ initTextbox(); return; }
      textbox.set({
        text: document.getElementById('textInput').value || ' ',
        fontSize: parseInt(document.getElementById('fontSizeSlider').value,10),
        fontWeight: document.getElementById('fontWeightSelect').value,
        fill: document.getElementById('textColor').value,
        lineHeight: parseFloat(document.getElementById('lineHeightSlider').value),
        padding: parseInt(document.getElementById('paddingSlider').value,10),
        shadow: document.getElementById('shadowToggle').checked ? 'rgba(0,0,0,0.5) 0px 8px 18px' : ''
      });
      canvas.renderAll();
      document.getElementById('fontSizeVal').innerText = document.getElementById('fontSizeSlider').value;
      document.getElementById('lineHeightVal').innerText = parseFloat(document.getElementById('lineHeightSlider').value).toFixed(1);
      document.getElementById('paddingVal').innerText = document.getElementById('paddingSlider').value;
    }

    document.getElementById('sizeSquareBtn').addEventListener('click', function(){
      this.classList.add('active');
      document.getElementById('sizeMatchBtn').classList.remove('active');
      matchMode = false;
      if(canvas.width !== 1080 || canvas.height !== 1080) resizeCanvas(1080,1080);
    });

    document.getElementById('sizeMatchBtn').addEventListener('click', function(){
      this.classList.add('active');
      document.getElementById('sizeSquareBtn').classList.remove('active');
      matchMode = true;
      if(canvas.backgroundImage){
        const img = canvas.backgroundImage; let targetW = img.width, targetH = img.height; const maxDim = 1080;
        if(targetW>maxDim||targetH>maxDim){ const ratio = Math.min(maxDim/targetW, maxDim/targetH); targetW = Math.floor(targetW*ratio); targetH = Math.floor(targetH*ratio); }
        resizeCanvas(targetW,targetH);
      }
    });

    function download(format){
      const dataURL = canvas.toDataURL({ format: format, quality: 1 });
      const link = document.createElement('a');
      link.download = `carasoul.${format}`;
      link.href = dataURL;
      link.click();
    }
    document.getElementById('downloadPngBtn').addEventListener('click', ()=> download('png'));
    document.getElementById('downloadJpgBtn').addEventListener('click', ()=> download('jpeg'));
    document.getElementById('duplicateSlideBtn').addEventListener('click', function(){
      const current = document.getElementById('textInput').value;
      document.getElementById('textInput').value = current + ' ‚ú¶';
      updateTextProperties();
    });
    document.getElementById('resetTextBtn').addEventListener('click', function(){
      document.getElementById('textInput').value = 'Carasoul Solvoro';
      document.getElementById('fontSizeSlider').value = 58;
      document.getElementById('fontWeightSelect').value = 'bold';
      document.getElementById('textColor').value = '#ffffff';
      document.getElementById('lineHeightSlider').value = 1.3;
      document.getElementById('paddingSlider').value = 32;
      document.getElementById('shadowToggle').checked = true;
      updateTextProperties();
    });

    // event bindings
    document.getElementById('textInput').addEventListener('input', updateTextProperties);
    document.getElementById('fontSizeSlider').addEventListener('input', updateTextProperties);
    document.getElementById('fontWeightSelect').addEventListener('change', updateTextProperties);
    document.getElementById('textColor').addEventListener('input', updateTextProperties);
    document.getElementById('lineHeightSlider').addEventListener('input', updateTextProperties);
    document.getElementById('paddingSlider').addEventListener('input', updateTextProperties);
    document.getElementById('shadowToggle').addEventListener('change', updateTextProperties);

    // drag & drop
    const dropArea = document.getElementById('uploadDrop');
    ['dragenter','dragover','dragleave','drop'].forEach(evt => dropArea.addEventListener(evt, preventDefaults, false));
    function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
    dropArea.addEventListener('drop', (e)=>{
      const dt = e.dataTransfer; const file = dt.files[0];
      if(file && file.type.match(/image.*/)){
        document.getElementById('bgUpload').files = dt.files;
        const event = new Event('change',{bubbles:true});
        document.getElementById('bgUpload').dispatchEvent(event);
      }
    });

    // init
    loadBackgroundFromStorage();
    initTextbox();
    document.getElementById('fontSizeVal').innerText = document.getElementById('fontSizeSlider').value;
    document.getElementById('lineHeightVal').innerText = document.getElementById('lineHeightSlider').value;
    document.getElementById('paddingVal').innerText = document.getElementById('paddingSlider').value;
    if(!localStorage.getItem(STORAGE_KEY)) document.getElementById('bgMessage').innerText = 'upload a background';

    // orientation / resize friendly: shrink preview for small screens visually
    window.addEventListener('orientationchange', ()=> {
      // small visual adjustment so mobile preview fits
      setTimeout(()=>{ document.getElementById('carouselCanvas').style.maxWidth = Math.min(window.innerWidth - 60, 1080) + 'px'; }, 300);
    });

    // ---- PWA install prompt handling ----
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');
    const iosInstall = document.getElementById('iosInstall');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installBtn.addEventListener('click', async () => {
        installBtn.disabled = true;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        installBtn.style.display = 'none';
      });
    });

    // show iOS hint if Safari on iPhone / iPad
    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
    if(isIos && !isInStandaloneMode){
      iosInstall.style.display = 'block';
    }

    // register service worker
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(err => {
        console.warn('SW registration failed:', err);
      });
    }
  })();
  </script>
</body>
</html>
